import os
import subprocess
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler,
    ContextTypes, filters
)

BOT_TOKEN = os.getenv("BOT_TOKEN") or "8327108993:AAE_hCDGuubnkURHMj3fj838YZhekyteoXw"

user_data = {}
active_streams = {}  # chat_id: subprocess.Popen
RESTART_DELAY = 10  # Ø«ÙˆØ§Ù†ÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« Ø¨Ø¹Ø¯ ØªÙˆÙ‚ÙÙ‡

# ---- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø« ----

async def start_stream(chat_id: int, stream_key: str, m3u8_url: str, context: ContextTypes.DEFAULT_TYPE):
    facebook_rtmp = f"rtmps://live-api-s.facebook.com:443/rtmp/{stream_key}"
    ffmpeg_cmd = [
        "ffmpeg",
        "-re", "-i", m3u8_url,
        "-c:v", "copy",
        "-c:a", "aac",
        "-f", "flv",
        facebook_rtmp
    ]

    try:
        proc = subprocess.Popen(ffmpeg_cmd)
        active_streams[chat_id] = proc
        await context.bot.send_message(chat_id, "âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­!")
        # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨Ø« Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªÙˆÙ‚ÙÙ‡
        asyncio.create_task(monitor_stream(chat_id, stream_key, m3u8_url, context))
    except Exception as e:
        await context.bot.send_message(chat_id, f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ ffmpeg:\n{e}")

async def monitor_stream(chat_id: int, stream_key: str, m3u8_url: str, context: ContextTypes.DEFAULT_TYPE):
    proc = active_streams.get(chat_id)
    if not proc:
        return
    proc.wait()
    # Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (ØªÙˆÙ‚Ù Ø§Ù„Ø¨Ø«)
    await context.bot.send_message(chat_id, "âš ï¸ Ø§Ù„Ø¨Ø« ØªÙˆÙ‚Ù! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...")
    await asyncio.sleep(RESTART_DELAY)
    await start_stream(chat_id, stream_key, m3u8_url, context)

async def stop_stream(chat_id: int, context: ContextTypes.DEFAULT_TYPE):
    proc = active_streams.get(chat_id)
    if proc:
        proc.terminate()
        await context.bot.send_message(chat_id, "ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.")
        active_streams.pop(chat_id, None)
    else:
        await context.bot.send_message(chat_id, "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ø¬Ø§Ø±ÙŠ.")

# ---- Ø£ÙˆØ§Ù…Ø± Telegram ----

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    keyboard = [
        [InlineKeyboardButton("Ø£Ø±Ø³Ù„ Stream Key", callback_data="send_stream_key")],
        [InlineKeyboardButton("Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· m3u8", callback_data="send_m3u8")],
        [InlineKeyboardButton("Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«", callback_data="stop_stream")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø«:", reply_markup=reply_markup)

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    chat_id = query.message.chat.id

    if query.data == "send_stream_key":
        await query.message.reply_text("Ø£Ø±Ø³Ù„ Stream Key Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:")
    elif query.data == "send_m3u8":
        await query.message.reply_text("Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· m3u8 Ù„Ù„Ø¨Ø«:")
    elif query.data == "stop_stream":
        await stop_stream(chat_id, context)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    text = update.message.text.strip()

    if chat_id not in user_data:
        user_data[chat_id] = {"stream_key": text}
        await update.message.reply_text("âœ… ØªÙ… Ø­ÙØ¸ Stream Key.\nØ§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· m3u8:")
        return

    stream_key = user_data[chat_id]["stream_key"]
    m3u8_url = text

    await update.message.reply_text("ğŸš€ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ...")
    await start_stream(chat_id, stream_key, m3u8_url, context)

async def send_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    if chat_id in active_streams:
        text_to_send = " ".join(context.args)
        if text_to_send:
            # ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ Ù„Ù„Ø¨Ø« Ø­Ø³Ø¨ Ø¯Ø¹Ù… FFmpeg
            await update.message.reply_text(f"ğŸ“ Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Øµ Ù„Ù„Ø¨Ø«: {text_to_send}")
        else:
            await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.")
    else:
        await update.message.reply_text("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ø¬Ø§Ø±ÙŠ.")

async def send_image(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    if chat_id in active_streams:
        image_url = context.args[0] if context.args else None
        if image_url:
            await update.message.reply_text(f"ğŸ–¼ï¸ Ø£Ø±Ø³Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¨Ø«: {image_url}")
        else:
            await update.message.reply_text("âŒ ÙŠØ±Ø¬Ù‰ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.")
    else:
        await update.message.reply_text("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ø¬Ø§Ø±ÙŠ.")

# ---- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ----

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("text", send_text))
    app.add_handler(CommandHandler("image", send_image))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(button))

    print("âœ… Bot started successfully")
    app.run_polling()

if __name__ == "__main__":
    main()
